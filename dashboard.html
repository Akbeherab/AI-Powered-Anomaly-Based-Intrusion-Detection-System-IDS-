<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time IDS Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heatmap.js/build/heatmap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- CSS -->
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --danger: #f72585;
            --warning: #f8961e;
            --success: #4cc9f0;
            --info: #4895ef;
            --dark: #212529;
            --light: #f8f9fa;
            
            --bg-color-light: #f8f9fa;
            --bg-color-dark: #121212;
            --card-bg-light: #ffffff;
            --card-bg-dark: #1e1e1e;
            --text-color-light: #212529;
            --text-color-dark: #f8f9fa;
            --border-color-light: #dee2e6;
            --border-color-dark: #444;
        }
        
        [data-theme="dark"] {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color-light);
        }
        
        [data-theme="dark"] header {
            border-bottom-color: var(--border-color-dark);
        }
        
        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }
        
        h1 {
            color: var(--primary);
            font-size: 2rem;
        }
        
        h2 {
            font-size: 1.5rem;
            margin: 25px 0 15px;
            color: var(--secondary);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--card-bg-light);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        [data-theme="dark"] .card {
            background: var(--card-bg-dark);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        #logSearch {
            padding: 10px 15px 10px 40px;
            width: 100%;
            border-radius: 30px;
            border: 1px solid var(--border-color-light);
            font-size: 0.9rem;
            background-color: var(--card-bg-light);
            color: var(--text-color-light);
        }
        
        [data-theme="dark"] #logSearch {
            border-color: var(--border-color-dark);
            background-color: var(--card-bg-dark);
            color: var(--text-color-dark);
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        [data-theme="dark"] .btn-outline {
            border-color: var(--secondary);
            color: var(--secondary);
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .badge-success {
            background-color: var(--success);
            color: var(--dark);
        }
        
        .badge-info {
            background-color: var(--info);
            color: white;
        }
        
        .badge-critical {
            background-color: #dc3545;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg-light);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        [data-theme="dark"] table {
            background: var(--card-bg-dark);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color-light);
        }
        
        [data-theme="dark"] th, 
        [data-theme="dark"] td {
            border-bottom-color: var(--border-color-dark);
        }
        
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }
        
        tr:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        [data-theme="dark"] tr:hover {
            background-color: rgba(67, 97, 238, 0.2);
        }
        
        .heatmap-container {
            width: 100%;
            height: 400px;
            background: var(--card-bg-light);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            position: relative;
        }
        
        [data-theme="dark"] .heatmap-container {
            background: var(--card-bg-dark);
        }
        
        .heatmap-title {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .log-count {
            font-weight: 600;
            color: var(--primary);
        }
        
        .ip-address {
            font-family: monospace;
        }
        
        .critical {
            color: var(--danger);
            font-weight: 600;
        }
        
        .warning {
            color: var(--warning);
            font-weight: 600;
        }
        
        .normal {
            color: var(--success);
            font-weight: 600;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-critical {
            background-color: var(--danger);
        }
        
        .status-warning {
            background-color: var(--warning);
        }
        
        .status-normal {
            background-color: var(--success);
        }
        
        .status-suspicious {
            background-color: var(--info);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: var(--success);
        }
        
        .notification.error {
            background-color: var(--danger);
        }
        
        .notification.info {
            background-color: var(--info);
        }
        
        .notification.warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .notification i {
            font-size: 1.2rem;
        }
        
        .alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
            text-align: center;
            display: none;
        }
        
        [data-theme="dark"] .alert-modal {
            background-color: var(--card-bg-dark);
            color: var(--text-color-dark);
        }
        
        .alert-modal h3 {
            color: var(--danger);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .alert-modal p {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .alert-modal .btn {
            margin: 0 10px;
        }
        
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .alert-modal {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-shield-alt"></i> Intrusion Detection System</h1>
                <p>Real-time network security monitoring dashboard</p>
            </div>
            <button id="themeToggle" class="btn btn-outline">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
        </header>
        
        <div class="controls">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="logSearch" placeholder="Search logs by IP, type, or severity...">
            </div>
            <div class="btn-group">
                <button class="download-btn btn btn-danger" id="downloadPdf">
                    <i class="fas fa-file-pdf"></i> Export Full Report
                </button>
                <button class="download-btn btn btn-warning" id="downloadZeroDayPdf">
                    <i class="fas fa-bug"></i> Zero-Day Report
                </button>
                <button class="download-btn btn btn-primary" id="downloadAttackStats">
                    <i class="fas fa-download"></i> Attack Stats
                </button>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">CPU Usage</div>
                    <div class="badge" id="cpuStatus">Normal</div>
                </div>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Network Latency</div>
                    <div class="badge" id="latencyStatus">Normal</div>
                </div>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Attack Types</div>
                    <div class="badge badge-danger" id="totalThreats">0 Threats</div>
                </div>
                <div class="chart-container">
                    <canvas id="attackPieChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Zero-Day Attacks</div>
                    <div class="badge badge-warning" id="zeroDayCount">0 Detected</div>
                </div>
                <div class="chart-container">
                    <canvas id="zeroDayChart"></canvas>
                </div>
            </div>
        </div>
        
        <h2>Live Network Activity <span class="log-count" id="logCount">0</span></h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>CPU Usage</th>
                        <th>Memory</th>
                        <th>Request Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="logTable">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <h2>Blocked Threats <span class="log-count" id="blockedCount">0</span></h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>Request Type</th>
                        <th>Severity</th>
                        <th>Reason</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="blockedTable">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <h2>Threat Heatmap</h2>
        <div class="heatmap-container">
            <h3 class="heatmap-title">Attack Origin Locations</h3>
            <div id="heatmapCanvas"></div>
        </div>
    </div>

    <!-- Notification element -->
    <div class="notification" id="notification"></div>
    
    <!-- Zero-day alert modal -->
    <div class="alert-overlay" id="alertOverlay"></div>
    <div class="alert-modal" id="zeroDayAlert">
        <h3><i class="fas fa-exclamation-triangle"></i> Zero-Day Attack Detected!</h3>
        <p id="zeroDayAlertContent">A previously unknown attack pattern has been detected in your network. Immediate action is recommended.</p>
        <div>
            <button class="btn btn-danger" id="viewZeroDayDetails">
                <i class="fas fa-search"></i> View Details
            </button>
            <button class="btn btn-outline" id="closeAlert">
                <i class="fas fa-times"></i> Dismiss
            </button>
        </div>
    </div>

    <script>
        // Initialize charts with better configuration
        const gradientFill = (ctx, color1, color2, height = 400) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            return gradient;
        };
        
        // Chart configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Poppins',
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: {
                        family: 'Poppins',
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        family: 'Poppins',
                        size: 12
                    },
                    padding: 12,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: 'Poppins',
                            size: 10
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        font: {
                            family: 'Poppins',
                            size: 10
                        }
                    }
                }
            },
            elements: {
                point: {
                    radius: 0,
                    hoverRadius: 6
                },
                line: {
                    borderWidth: 2,
                    tension: 0.4
                }
            }
        };
        
        // Dark mode chart options
        const darkChartOptions = JSON.parse(JSON.stringify(chartOptions));
        darkChartOptions.scales.y.grid.color = 'rgba(255,255,255,0.05)';
        
        // Initialize charts
        const cpuCtx = document.getElementById('cpuChart').getContext('2d');
        const latencyCtx = document.getElementById('latencyChart').getContext('2d');
        const zeroDayCtx = document.getElementById('zeroDayChart').getContext('2d');
        
        let cpuChart = new Chart(cpuCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage %',
                    data: [],
                    borderColor: '#4361ee',
                    backgroundColor: gradientFill(cpuCtx, 'rgba(67, 97, 238, 0.4)', 'rgba(67, 97, 238, 0.05)'),
                    fill: true
                }]
            },
            options: chartOptions
        });
        
        let latencyChart = new Chart(latencyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Latency (ms)',
                    data: [],
                    borderColor: '#4cc9f0',
                    backgroundColor: gradientFill(latencyCtx, 'rgba(76, 201, 240, 0.4)', 'rgba(76, 201, 240, 0.05)'),
                    fill: true
                }]
            },
            options: chartOptions
        });
        
        // Stacked zero-day chart
        let zeroDayChart = new Chart(zeroDayCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Critical',
                        data: [],
                        backgroundColor: '#f72585',
                        stack: 'Stack 0'
                    },
                    {
                        label: 'High',
                        data: [],
                        backgroundColor: '#7209b7',
                        stack: 'Stack 0'
                    },
                    {
                        label: 'Medium',
                        data: [],
                        backgroundColor: '#f8961e',
                        stack: 'Stack 0'
                    },
                    {
                        label: 'Low',
                        data: [],
                        backgroundColor: '#4895ef',
                        stack: 'Stack 0'
                    }
                ]
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    tooltip: {
                        ...chartOptions.plugins.tooltip,
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    ...chartOptions.scales,
                    x: {
                        ...chartOptions.scales.x,
                        stacked: true
                    },
                    y: {
                        ...chartOptions.scales.y,
                        stacked: true
                    }
                }
            }
        });
        
        let attackPieChart = new Chart(document.getElementById('attackPieChart'), {
            type: 'doughnut',
            data: {
                labels: ['DDoS', 'Brute Force', 'SQL Injection', 'Zero-Day', 'Phishing', 'XSS'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#f72585',
                        '#f8961e',
                        '#7209b7',
                        '#212529',
                        '#4895ef',
                        '#4cc9f0'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                ...chartOptions,
                cutout: '70%',
                plugins: {
                    ...chartOptions.plugins,
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 20
                        }
                    }
                }
            }
        });
        
        // Initialize heatmap
        let heatmapInstance = h337.create({
            container: document.getElementById('heatmapCanvas'),
            maxOpacity: 0.8,
            radius: 25,
            blur: 0.9,
            gradient: {
                0.4: 'blue',
                0.6: 'cyan',
                0.7: 'lime',
                0.8: 'yellow',
                1.0: 'red'
            }
        });
        
        // Notification function
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                 type === 'error' ? 'fa-exclamation-circle' : 
                                 type === 'warning' ? 'fa-exclamation-triangle' :
                                 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Show zero-day alert modal
        function showZeroDayAlert(attackDetails) {
            const modal = document.getElementById('zeroDayAlert');
            const overlay = document.getElementById('alertOverlay');
            const content = document.getElementById('zeroDayAlertContent');
            
            content.innerHTML = `
                <p><strong>Timestamp:</strong> ${new Date(attackDetails.timestamp).toLocaleString()}</p>
                <p><strong>IP Address:</strong> ${attackDetails.IP}</p>
                <p><strong>Attack Type:</strong> ${attackDetails["Request Type"]}</p>
                <p><strong>Severity:</strong> <span class="badge badge-critical">Critical</span></p>
                <p>${attackDetails.Reason || 'A previously unknown attack pattern has been detected.'}</p>
            `;
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Store the attack details for viewing
            modal.dataset.attackDetails = JSON.stringify(attackDetails);
        }
        
        // Close alert modal
        document.getElementById('closeAlert').addEventListener('click', () => {
            document.getElementById('zeroDayAlert').style.display = 'none';
            document.getElementById('alertOverlay').style.display = 'none';
        });
        
        // View zero-day details
        document.getElementById('viewZeroDayDetails').addEventListener('click', () => {
            const modal = document.getElementById('zeroDayAlert');
            const attackDetails = JSON.parse(modal.dataset.attackDetails);
            
            // Scroll to the blocked table and highlight the row
            const blockedTable = document.getElementById('blockedTable');
            const rows = blockedTable.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (row.textContent.includes(attackDetails.IP) ){
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.style.animation = 'highlight 2s';
                    setTimeout(() => {
                        row.style.animation = '';
                    }, 2000);
                    break;
                }
            }
            
            modal.style.display = 'none';
            document.getElementById('alertOverlay').style.display = 'none';
        });
        
        // Real-time update interval (in milliseconds)
        const UPDATE_INTERVAL = 2000;
        let updateInterval;
        let lastZeroDayCount = 0;
        
        // Track attack counts over time for export
        let attackStats = {
            timestamps: [],
            counts: {
                ddos: [],
                bruteForce: [],
                sqlInjection: [],
                zeroDay: [],
                phishing: [],
                xss: []
            }
        };
        
        // Fetch data from backend
        async function fetchData() {
            try {
                const [logsResponse, attackTypesResponse] = await Promise.all([
                    axios.get('/api/logs'),
                    axios.get('/api/attack_types')
                ]);
                
                updateDashboard(logsResponse.data);
                updateAttackTypes(attackTypesResponse.data);
                
                // Check for new zero-day attacks
                if (logsResponse.data.stats.zero_day > lastZeroDayCount) {
                    const newZeroDayAttacks = logsResponse.data.blocked_logs
                        .filter(log => log["Request Type"] === "Zero-Day" && 
                                new Date(log.timestamp).getTime() > Date.now() - UPDATE_INTERVAL * 2);
                    
                    if (newZeroDayAttacks.length > 0) {
                        showZeroDayAlert(newZeroDayAttacks[0]);
                        showNotification(`Zero-day attack detected from ${newZeroDayAttacks[0].IP}`, 'warning');
                    }
                    
                    lastZeroDayCount = logsResponse.data.stats.zero_day;
                }
                
                // Record attack stats for export
                const now = new Date();
                attackStats.timestamps.push(now.toISOString());
                attackStats.counts.ddos.push(attackTypesResponse.data["DDoS"] || 0);
                attackStats.counts.bruteForce.push(attackTypesResponse.data["Brute Force"] || 0);
                attackStats.counts.sqlInjection.push(attackTypesResponse.data["SQL Injection"] || 0);
                attackStats.counts.zeroDay.push(attackTypesResponse.data["Zero-Day"] || 0);
                attackStats.counts.phishing.push(attackTypesResponse.data["Phishing"] || 0);
                attackStats.counts.xss.push(attackTypesResponse.data["XSS"] || 0);
                
                // Keep only the last 100 data points
                if (attackStats.timestamps.length > 100) {
                    attackStats.timestamps.shift();
                    attackStats.counts.ddos.shift();
                    attackStats.counts.bruteForce.shift();
                    attackStats.counts.sqlInjection.shift();
                    attackStats.counts.zeroDay.shift();
                    attackStats.counts.phishing.shift();
                    attackStats.counts.xss.shift();
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
                
            }
        }
        
        function updateDashboard(data) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // Update CPU chart
            if (cpuChart.data.labels.length > 15) {
                cpuChart.data.labels.shift();
                cpuChart.data.datasets[0].data.shift();
            }
            cpuChart.data.labels.push(timeStr);
            cpuChart.data.datasets[0].data.push(data.stats.cpu);
            cpuChart.update();
            
            // Update CPU status badge
            const lastCpu = data.stats.cpu;
            const cpuStatus = document.getElementById('cpuStatus');
            cpuStatus.textContent = lastCpu > 80 ? 'High' : lastCpu > 50 ? 'Medium' : 'Normal';
            cpuStatus.className = lastCpu > 80 ? 'badge badge-danger' : lastCpu > 50 ? 'badge badge-warning' : 'badge badge-success';
            
            // Update Latency chart
            if (latencyChart.data.labels.length > 15) {
                latencyChart.data.labels.shift();
                latencyChart.data.datasets[0].data.shift();
            }
            latencyChart.data.labels.push(timeStr);
            latencyChart.data.datasets[0].data.push(data.stats.latency);
            latencyChart.update();
            
            // Update Latency status badge
            const lastLatency = data.stats.latency;
            const latencyStatus = document.getElementById('latencyStatus');
            latencyStatus.textContent = lastLatency > 300 ? 'High' : lastLatency > 150 ? 'Medium' : 'Normal';
            latencyStatus.className = lastLatency > 300 ? 'badge badge-danger' : lastLatency > 150 ? 'badge badge-warning' : 'badge badge-success';
            
            // Update Zero-Day chart (stacked)
            if (zeroDayChart.data.labels.length > 10) {
                zeroDayChart.data.labels.shift();
                zeroDayChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            zeroDayChart.data.labels.push(timeStr);
            
            // Update with severity breakdown (in a real app, this would come from the backend)
            const severityCounts = {
                Critical: Math.floor(Math.random() * 3),
                High: Math.floor(Math.random() * 5),
                Medium: Math.floor(Math.random() * 7),
                Low: Math.floor(Math.random() * 10)
            };
            
            zeroDayChart.data.datasets[0].data.push(severityCounts.Critical);
            zeroDayChart.data.datasets[1].data.push(severityCounts.High);
            zeroDayChart.data.datasets[2].data.push(severityCounts.Medium);
            zeroDayChart.data.datasets[3].data.push(severityCounts.Low);
            zeroDayChart.update();
            
            // Update Zero-Day count badge
            document.getElementById('zeroDayCount').textContent = `${data.stats.zero_day} Detected`;
            
            // Update total threats badge
            document.getElementById('totalThreats').textContent = `${data.stats.total_threats} Threats`;
            
            // Filter logs based on search
            const search = $('#logSearch').val().toLowerCase();
            const filteredLogs = data.live_logs.filter(log => 
                Object.values(log).some(v => 
                    v && v.toString().toLowerCase().includes(search)
                )
            );
            
            // Update live logs table
            $('#logTable').html(filteredLogs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="ip-address">${log.IP}</td>
                    <td>${log.CPU}%</td>
                    <td>${log.Memory}MB</td>
                    <td>${log["Request Type"]}</td>
                    <td>
                        <span class="status-indicator ${log.Status === 'Critical' ? 'status-critical' : 
                            log.Status === 'Suspicious' ? 'status-suspicious' : 'status-normal'}"></span>
                        <span class="${log.Status === 'Critical' ? 'critical' : 
                            log.Status === 'Suspicious' ? 'warning' : 'normal'}">
                            ${log.Status}
                        </span>
                    </td>
                </tr>
            `).reverse().join(""));
            
            $('#logCount').text(filteredLogs.length);
            
            // Update blocked logs table
            const filteredBlockedLogs = data.blocked_logs.filter(log => 
                search ? Object.values(log).some(v => 
                    v && v.toString().toLowerCase().includes(search)
                ) : true
            );
            
            $('#blockedTable').html(filteredBlockedLogs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="ip-address">${log.IP}</td>
                    <td>${log["Request Type"]}</td>
                    <td>
                        <span class="badge ${log.Severity === 'Critical' ? 'badge-critical' : 
                            log.Severity === 'High' ? 'badge-danger' : 
                            log.Severity === 'Medium' ? 'badge-warning' : 'badge-info'}">
                            ${log.Severity}
                        </span>
                    </td>
                    <td>${log.Reason}</td>
                    <td>
                        <button class="btn btn-outline block-ip-btn" data-ip="${log.IP}" style="padding: 3px 8px; font-size: 0.8rem;">
                            <i class="fas fa-ban"></i> Permanent Block
                        </button>
                    </td>
                </tr>
            `).reverse().join(""));
            
            $('#blockedCount').text(filteredBlockedLogs.length);
            
            // Update heatmap
            heatmapInstance.setData({
                max: 10,
                data: data.blocked_logs.map(() => ({
                    x: Math.floor(Math.random() * document.getElementById('heatmapCanvas').offsetWidth),
                    y: Math.floor(Math.random() * document.getElementById('heatmapCanvas').offsetHeight),
                    value: Math.floor(Math.random() * 10) + 1
                }))
            });
        }
        
        function updateAttackTypes(attackData) {
            attackPieChart.data.datasets[0].data = [
                attackData["DDoS"] || 0,
                attackData["Brute Force"] || 0,
                attackData["SQL Injection"] || 0,
                attackData["Zero-Day"] || 0,
                attackData["Phishing"] || 0,
                attackData["XSS"] || 0
            ];
            attackPieChart.update();
        }
        
        // Handle IP blocking
        $(document).on('click', '.block-ip-btn', function() {
            const ip = $(this).data('ip');
            axios.post('/api/block_ip', { ip: ip })
                .then(response => {
                    showNotification(`IP ${ip} blocked successfully`, 'success');
                })
                .catch(error => {
                    console.error('Error blocking IP:', error);
                    showNotification('Failed to block IP', 'error');
                });
        });
        
        // Theme toggle functionality
        $('#themeToggle').on('click', () => {
            const body = $('html');
            const theme = body.attr('data-theme');
            const isDark = theme === 'dark';
            
            body.attr('data-theme', isDark ? 'light' : 'dark');
            $('#themeToggle').html(`<i class="fas ${isDark ? 'fa-moon' : 'fa-sun'}"></i> ${isDark ? 'Dark' : 'Light'} Mode`);
            
            // Update charts for theme
            const options = isDark ? chartOptions : darkChartOptions;
            cpuChart.options = options;
            latencyChart.options = options;
            zeroDayChart.options = options;
            attackPieChart.options = {
                ...options,
                cutout: '70%',
                plugins: {
                    ...options.plugins,
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 20,
                            color: isDark ? '#fff' : '#000'
                        }
                    }
                }
            };
            
            cpuChart.update();
            latencyChart.update();
            zeroDayChart.update();
            attackPieChart.update();
        });
        
        // Search functionality
        $('#logSearch').on('input', fetchData);
        
        // PDF export functionality
        document.getElementById('downloadPdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Show loading notification
            showNotification('Generating full report...', 'info');
            
            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(67, 97, 238);
            doc.text('Intrusion Detection System Report', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 30, { align: 'center' });
            
            // Summary section
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Security Summary', 20, 45);
            
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text(`Total Threats Detected: ${document.getElementById('blockedCount').textContent}`, 20, 55);
            doc.text(`Zero-Day Attacks: ${document.getElementById('zeroDayCount').textContent}`, 20, 65);
            
            // Attack distribution chart
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Attack Type Distribution', 20, 85);
            
            // Add pie chart image (in a real app, you would generate this from the chart)
            doc.addImage('https://via.placeholder.com/150x100?text=Attack+Distribution+Chart', 'PNG', 20, 90, 170, 80);
            
            // Blocked threats table
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Blocked Threats Details', 20, 185);
            
            const tableRows = Array.from(document.querySelectorAll('#blockedTable tr')).map((row, i) => {
                const cells = Array.from(row.cells);
                return [
                    i + 1,
                    cells[1].textContent, // IP
                    cells[2].textContent, // Request Type
                    cells[3].textContent, // Severity
                    cells[4].textContent  // Reason
                ];
            });
            
            doc.autoTable({
                head: [['#', 'IP Address', 'Request Type', 'Severity', 'Reason']],
                body: tableRows,
                startY: 195,
                styles: {
                    font: 'helvetica',
                    fontSize: 10,
                    cellPadding: 5,
                    fillColor: [67, 97, 238],
                    textColor: [255, 255, 255],
                    halign: 'center'
                },
                headStyles: {
                    fillColor: [33, 37, 41],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 45 }
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                }
            });
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Confidential - Generated by IDS Dashboard', 105, doc.internal.pageSize.height - 10, { align: 'center' });
            
            doc.save(`IDS_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            
            showNotification('Full report generated', 'success');
        });
        
        // Zero-Day PDF export functionality
        document.getElementById('downloadZeroDayPdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Show loading notification
            showNotification('Generating Zero-Day Attack Report...', 'info');
            
            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(247, 37, 133);
            doc.text('Zero-Day Attack Report', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 30, { align: 'center' });
            
            // Summary
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Zero-Day Attack Summary', 20, 45);
            
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text(`Total Zero-Day Attacks Detected: ${document.getElementById('zeroDayCount').textContent}`, 20, 55);
            doc.text(`Last Detected: ${new Date().toLocaleString()}`, 20, 65);
            
            // Zero-Day chart
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Zero-Day Attack Trend', 20, 85);
            
            // Add chart image (in a real app, you would generate this from the chart)
            doc.addImage('https://via.placeholder.com/150x100?text=Zero-Day+Attack+Trend', 'PNG', 20, 90, 170, 80);
            
            // Zero-Day attacks table
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Zero-Day Attack Details', 20, 185);
            
            const zeroDayRows = Array.from(document.querySelectorAll('#blockedTable tr'))
                .filter(row => row.cells[2].textContent.includes('Zero-Day'))
                .map((row, i) => {
                    const cells = Array.from(row.cells);
                    return [
                        i + 1,
                        cells[0].textContent, // Timestamp
                        cells[1].textContent, // IP
                        cells[3].textContent, // Severity
                        cells[4].textContent  // Reason
                    ];
                });
            
            if (zeroDayRows.length > 0) {
                doc.autoTable({
                    head: [['#', 'Timestamp', 'IP Address', 'Severity', 'Details']],
                    body: zeroDayRows,
                    startY: 195,
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 5,
                        fillColor: [247, 37, 133],
                        textColor: [255, 255, 255],
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [33, 37, 41],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 10 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 30 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 45 }
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    }
                });
            } else {
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('No zero-day attacks detected in current data set', 20, 195);
            }
            
            // Recommendations
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Recommended Actions', 20, doc.autoTable.previous.finalY + 20);
            
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text('1. Immediately isolate affected systems from the network', 20, doc.autoTable.previous.finalY + 30);
            doc.text('2. Update all security signatures and patches', 20, doc.autoTable.previous.finalY + 40);
            doc.text('3. Conduct forensic analysis on affected systems', 20, doc.autoTable.previous.finalY + 50);
            doc.text('4. Notify relevant security teams and stakeholders', 20, doc.autoTable.previous.finalY + 60);
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('CRITICAL - Handle with extreme confidentiality', 105, doc.internal.pageSize.height - 10, { align: 'center' });
            
            doc.save(`ZeroDay_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            
            showNotification('Zero-Day report generated', 'success');
        });
        
        // Download attack stats as CSV
        document.getElementById('downloadAttackStats').addEventListener('click', () => {
            // Create CSV content
            let csvContent = "Timestamp,DDoS,Brute Force,SQL Injection,Zero-Day,Phishing,XSS\n";
            
            for (let i = 0; i < attackStats.timestamps.length; i++) {
                csvContent += `${attackStats.timestamps[i]},` +
                             `${attackStats.counts.ddos[i]},` +
                             `${attackStats.counts.bruteForce[i]},` +
                             `${attackStats.counts.sqlInjection[i]},` +
                             `${attackStats.counts.zeroDay[i]},` +
                             `${attackStats.counts.phishing[i]},` +
                             `${attackStats.counts.xss[i]}\n`;
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `attack_stats_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Attack statistics downloaded', 'success');
        });
        
        // Initialize dashboard and set up polling
        fetchData();
        updateInterval = setInterval(fetchData, UPDATE_INTERVAL);
    </script>
</body>
</html>

